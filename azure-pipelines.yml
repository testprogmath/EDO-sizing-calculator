name: $(date:yyyyMMdd).$(rev:r)

trigger:
  branches:
    include:
      - main
      - master
  paths:
    include:
      - '*'

pool:
  name: efros-do-pool
  demands:
    - Agent.OS -equals Linux

variables:
  - name: VERSION
    value: $(Build.BuildNumber)-RC

stages:
  - stage: Build
    displayName: 'Build Static Site'
    jobs:
      - job: Build
        displayName: 'Build Job'
        steps:
          - checkout: self
            displayName: 'Checkout Repository'
          
          - script: |
              echo "Building NAC Calculator version $(VERSION)"
              echo "Build Date: $(date)"
              echo "Build Number: $(Build.BuildNumber)"
            displayName: 'Display Build Info'
          
          # Проверка структуры файлов
          - script: |
              ls -la
              echo "=== Files structure ==="
              find . -name "*.html" -o -name "*.js" -o -name "*.css" | head -20
            displayName: 'Check Files Structure'
          
          # Валидация HTML файлов
          - script: |
              echo "=== Validating HTML files ==="
              for file in *.html; do
                if [ -f "$file" ]; then
                  echo "Checking $file..."
                  # Простая проверка что файл содержит основные HTML теги
                  if grep -q "<html" "$file" && grep -q "</html>" "$file"; then
                    echo "✓ $file looks valid"
                  else
                    echo "✗ $file might be invalid"
                    exit 1
                  fi
                fi
              done
            displayName: 'Validate HTML Files'
          
          # Проверка JavaScript файлов
          - script: |
              echo "=== Checking JavaScript files ==="
              for file in js/*.js; do
                if [ -f "$file" ]; then
                  echo "Checking $file..."
                  # Проверяем что файл не пустой и содержит JS код
                  if [ -s "$file" ] && (grep -q "function\|const\|let\|var" "$file"); then
                    echo "✓ $file looks valid"
                  else
                    echo "✗ $file might be empty or invalid"
                    exit 1
                  fi
                fi
              done
            displayName: 'Validate JavaScript Files'
          
          # Создание архива для артефактов
          - script: |
              echo "=== Creating build artifact ==="
              mkdir -p $(Build.ArtifactStagingDirectory)/nac-calculator
              cp -r . $(Build.ArtifactStagingDirectory)/nac-calculator/
              # Удаляем .git и другие служебные файлы
              rm -rf $(Build.ArtifactStagingDirectory)/nac-calculator/.git
              rm -f $(Build.ArtifactStagingDirectory)/nac-calculator/azure-pipelines.yml
              echo "Build completed successfully"
            displayName: 'Prepare Build Artifact'
          
          # Публикация артефактов
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/nac-calculator'
              ArtifactName: 'nac-calculator-$(VERSION)'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy to Static Hosting'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: 'Deploy Static Files'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: 'nac-calculator-$(VERSION)'
                  displayName: 'Download Build Artifacts'
                
                - script: |
                    echo "=== Deploying NAC Calculator ==="
                    echo "Version: $(VERSION)"
                    echo "Artifact location: $(Pipeline.Workspace)/nac-calculator-$(VERSION)"
                    ls -la $(Pipeline.Workspace)/nac-calculator-$(VERSION)
                  displayName: 'Display Deploy Info'
                
                # Вариант 1: Копирование в веб-директорию (если есть веб-сервер)
                - script: |
                    echo "=== Deploying to web directory ==="
                    # Замените /var/www/html на реальный путь к веб-директории
                    WEB_DIR="/var/www/html/nac-calculator"
                    
                    # Создание резервной копии
                    if [ -d "$WEB_DIR" ]; then
                      sudo cp -r "$WEB_DIR" "$WEB_DIR.backup.$(date +%Y%m%d_%H%M%S)"
                      echo "Backup created"
                    fi
                    
                    # Создание директории если не существует
                    sudo mkdir -p "$WEB_DIR"
                    
                    # Копирование файлов
                    sudo cp -r $(Pipeline.Workspace)/nac-calculator-$(VERSION)/* "$WEB_DIR/"
                    
                    # Установка правильных прав
                    sudo chown -R www-data:www-data "$WEB_DIR"
                    sudo chmod -R 644 "$WEB_DIR"
                    sudo chmod 755 "$WEB_DIR"
                    
                    echo "Deployment completed to $WEB_DIR"
                  displayName: 'Deploy to Web Directory'
                  condition: false # Отключено по умолчанию, включите если нужно
                
                # Вариант 2: Создание tar.gz архива для ручного развертывания
                - script: |
                    echo "=== Creating deployment package ==="
                    cd $(Pipeline.Workspace)
                    tar -czf nac-calculator-$(VERSION).tar.gz -C nac-calculator-$(VERSION) .
                    echo "Deployment package created: nac-calculator-$(VERSION).tar.gz"
                    
                    # Информация для ручного развертывания
                    echo "=== Manual deployment instructions ==="
                    echo "1. Download the artifact: nac-calculator-$(VERSION).tar.gz"
                    echo "2. Extract to web server directory:"
                    echo "   tar -xzf nac-calculator-$(VERSION).tar.gz -C /var/www/html/nac-calculator"
                    echo "3. Set permissions:"
                    echo "   chown -R www-data:www-data /var/www/html/nac-calculator"
                    echo "   chmod -R 644 /var/www/html/nac-calculator"
                    echo "   chmod 755 /var/www/html/nac-calculator"
                  displayName: 'Create Deployment Package'
                
                # Публикация финального артефакта
                - task: PublishBuildArtifacts@1
                  displayName: 'Publish Deployment Package'
                  inputs:
                    PathtoPublish: '$(Pipeline.Workspace)'
                    ArtifactName: 'deployment-package-$(VERSION)'
                    publishLocation: 'Container'